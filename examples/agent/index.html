<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Simple Agent Workflow Demo</title>
    <style>
      body { 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
        margin: 40px; 
        background: #f8fafc;
        color: #334155;
      }
      .container { 
        max-width: 800px; 
        margin: 0 auto; 
        background: white; 
        border-radius: 12px; 
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        padding: 32px;
      }
      h1 { 
        color: #1e293b; 
        text-align: center; 
        margin-bottom: 8px;
      }
      .subtitle {
        text-align: center;
        color: #64748b;
        margin-bottom: 32px;
        font-size: 16px;
      }
      .input-section {
        margin-bottom: 24px;
        padding: 20px;
        background: #f1f5f9;
        border-radius: 8px;
      }
      .input-group {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 16px;
      }
      label {
        min-width: 100px;
        font-weight: 500;
        color: #475569;
      }
      input {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
      }
      input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      button {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: background 0.2s;
      }
      button:hover:not(:disabled) {
        background: #2563eb;
      }
      button:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }
      .output-section {
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        min-height: 300px;
        overflow: hidden;
      }
      .output-header {
        background: #1e293b;
        color: white;
        padding: 12px 16px;
        font-weight: 500;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .status {
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 12px;
        background: #374151;
      }
      .status.running {
        background: #059669;
        animation: pulse 2s infinite;
      }
      .status.completed {
        background: #059669;
      }
      .status.error {
        background: #dc2626;
      }
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
      }
      .output-content {
        padding: 16px;
        max-height: 400px;
        overflow-y: auto;
      }
      .step {
        margin-bottom: 16px;
        padding: 12px;
        border-radius: 6px;
        border-left: 4px solid #e2e8f0;
      }
      .step.thinking {
        background: #eff6ff;
        border-left-color: #3b82f6;
      }
      .step.tool_call {
        background: #fff7ed;
        border-left-color: #f59e0b;
      }
      .step.response {
        background: #ecfdf5;
        border-left-color: #10b981;
      }
      .step.error {
        background: #fef2f2;
        border-left-color: #ef4444;
      }
      .step-header {
        font-weight: 600;
        margin-bottom: 4px;
        font-size: 14px;
      }
      .step-content {
        color: #4b5563;
        line-height: 1.5;
      }
      .tool-info {
        background: rgba(0, 0, 0, 0.05);
        padding: 8px;
        border-radius: 4px;
        margin-top: 8px;
        font-family: monospace;
        font-size: 12px;
      }
      .empty-state {
        text-align: center;
        color: #9ca3af;
        padding: 60px 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ü§ñ Simple Agent Workflow</h1>
      <p class="subtitle">Watch an AI agent solve problems step-by-step</p>
      
      <div class="input-section">
        <div class="input-group">
          <label for="task">Task:</label>
          <input 
            id="task" 
            type="text" 
            placeholder="Enter a math problem"
            value="Ashley bought a big bag of candy to share with her friends. In total, there were 296 candies. She gave 105 candies to Marissa. She also gave 86 candies to Kayla. How many candies were left?"
          />
        </div>
        <div class="input-group">
          <button id="runBtn">üöÄ Run Math Agent</button>
          <button id="clearBtn">üóëÔ∏è Clear</button>
        </div>
      </div>

      <div class="output-section">
        <div class="output-header">
          <span>Agent Output</span>
          <span id="status" class="status">Ready</span>
        </div>
        <div class="output-content" id="output">
          <div class="empty-state">
            <p>Enter a task above and click "Run Agent" to see the AI work step-by-step!</p>
            <p style="font-size: 14px; margin-top: 16px;">
              Try: "Calculate 25 * 4 + 10", "What's 50% of 200?", or "Add 15 + 27 + 33"
            </p>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { createAgentSession } from '../../dist/index.js';

      const taskInput = document.getElementById('task');
      const runBtn = document.getElementById('runBtn');
      const clearBtn = document.getElementById('clearBtn');
      const output = document.getElementById('output');
      const status = document.getElementById('status');

      // Simple calculator tool
      const calculatorTool = {
        type: 'function',
        function: {
          name: 'calculate',
          description: 'Perform mathematical calculations',
          parameters: {
            type: 'object',
            properties: {
              expression: {
                type: 'string',
                description: 'Mathematical expression to evaluate (e.g., "15 * 23 + 47")'
              }
            },
            required: ['expression']
          },
          implementation: (expression) => {
            try {
              // Simple safe evaluation for demo purposes
              // In production, use a proper math parser
              const sanitized = expression.replace(/[^0-9+\-*/(). ]/g, '');
              const result = eval(sanitized);
              return `${expression} = ${result}`;
            } catch (error) {
              return `Error: Could not calculate "${expression}"`;
            }
          }
        }
      };

      // Simple 3-step workflow
      const mathWorkflow = {
        id: 'math-problem-solver',
        name: 'Math Problem Solver',
        description: 'Solves math problems step by step',
        maxIterations: 4,
        timeout: 50000,
        steps: [
          {
            id: 'understand',
            type: 'think',
            description: 'Understand the math problem and identify the steps that must be taken to solve it. You do not need to calculate the final answer.',
            nextSteps: ['calculate']
          },
          {
            id: 'calculate',
            type: 'act',
            description: 'Use the calculator tool to calculate the answer, based on the steps outlined.',
            tools: ['calculate'],
            nextSteps: ['explain']
          },
          {
            id: 'explain',
            type: 'respond',
            description: 'Explain the solution in a clear and friendly way.'
          }
        ],
        tools: [calculatorTool]
      };

      function updateStatus(text, className = '') {
        status.textContent = text;
        status.className = `status ${className}`;
      }

      function addStep(stepResult) {
        const stepDiv = document.createElement('div');
        stepDiv.className = `step ${stepResult.type}`;
        
        const header = document.createElement('div');
        header.className = 'step-header';
        
        const typeIcons = {
          thinking: 'ü§î',
          tool_call: 'üîß',
          response: 'üí¨',
          error: '‚ùå'
        };
        
        header.textContent = `${typeIcons[stepResult.type] || '‚Ä¢'} Step: ${stepResult.stepId}`;
        
        const content = document.createElement('div');
        content.className = 'step-content';
        content.textContent = stepResult.content;
        
        stepDiv.appendChild(header);
        stepDiv.appendChild(content);
        
        // Add tool info if present
        if (stepResult.toolCall) {
          const toolInfo = document.createElement('div');
          toolInfo.className = 'tool-info';
          toolInfo.textContent = `üîß ${stepResult.toolCall.name}("${stepResult.toolCall.args.expression || ''}")`;
          if (stepResult.toolCall.result) {
            toolInfo.textContent += ` ‚Üí ${stepResult.toolCall.result}`;
          }
          stepDiv.appendChild(toolInfo);
        }
        
        output.appendChild(stepDiv);
        output.scrollTop = output.scrollHeight;
      }

      function clearOutput() {
        output.innerHTML = '<div class="empty-state"><p>Output cleared. Ready for next task!</p></div>';
        updateStatus('Ready');
      }

      async function runAgent() {
        const task = taskInput.value.trim();
        if (!task) {
          alert('Please enter a task!');
          return;
        }

        runBtn.disabled = true;
        clearOutput();
        updateStatus('Starting agent...', 'running');

        try {
          // Create agent session
          const agent = await createAgentSession();

          updateStatus('Agent running...', 'running');

          // Modify workflow to include user task
          const taskWorkflow = {
            ...mathWorkflow,
            steps: mathWorkflow.steps.map(step => ({
              ...step,
              description: step.description + `\n\nUser's task: "${task}"`
            }))
          };

          // Run the workflow
          let stepCount = 0;
          for await (const stepResult of agent.runWorkflow(taskWorkflow)) {
            stepCount++;
            addStep(stepResult);
            
            if (stepResult.isComplete) {
              // console.log(`Completed step: ${stepResult.stepId}`);
            }
            
            if (stepResult.error) {
              updateStatus('Error occurred', 'error');
              break;
            }
          }

          updateStatus(`Completed (${stepCount} steps)`, 'completed');
          await agent.dispose();

        } catch (error) {
          console.error('Agent error:', error);
          updateStatus('Failed', 'error');
          
          const errorDiv = document.createElement('div');
          errorDiv.className = 'step error';
          errorDiv.innerHTML = `
            <div class="step-header">‚ùå Error</div>
            <div class="step-content">Failed to run agent: ${error.message}</div>
          `;
          output.appendChild(errorDiv);
        } finally {
          runBtn.disabled = false;
        }
      }

      // Event listeners
      runBtn.addEventListener('click', runAgent);
      clearBtn.addEventListener('click', clearOutput);
      
      taskInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          runAgent();
        }
      });
    </script>
  </body>
</html>